<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restaurant Menu</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  background: linear-gradient(135deg,#0D001A,#1A0030,#000D1A);
  font-family: Poppins, sans-serif;
}
.glass{
  background: rgba(255,255,255,0.06);
  backdrop-filter: blur(20px);
  border:1px solid rgba(255,105,180,0.2);
}
.btn-grad{
  background: linear-gradient(135deg,#FF006E,#8B00FF);
}
</style>
</head>
<body class="text-white">

<div class="max-w-lg mx-auto p-4">

<!-- HEADER -->
<div class="flex justify-between items-center mb-4">
  <div>
    <h1 id="restaurantName" class="font-bold text-lg"></h1>
    <p id="tableInfo" class="text-sm opacity-70"></p>
  </div>
</div>

<!-- ORDER TYPE -->
<div class="flex gap-2 mb-4">
  <button id="dineBtn" class="flex-1 py-2 rounded-xl btn-grad">üçΩ Dine In</button>
  <button id="onlineBtn" class="flex-1 py-2 rounded-xl glass">üõµ Online</button>
</div>

<!-- SEARCH -->
<input id="searchInput" type="text" placeholder="Search..." 
class="w-full p-3 rounded-xl glass mb-4">

<!-- CATEGORIES -->
<div id="categories" class="flex gap-3 overflow-x-auto mb-4"></div>

<!-- MENU -->
<div id="menu" class="grid grid-cols-2 gap-3"></div>

<!-- CART BUTTON -->
<button id="cartBtn" 
class="fixed bottom-6 right-6 w-14 h-14 rounded-full btn-grad hidden">
üõí
</button>

</div>

<script>

// SUPABASE
const SUPABASE_URL = "https://nauqzjzbmlzdnnryzdan.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_ypvRXwLPQbokKid4nGi8AA_dITP8eca";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// STATE
let restaurant = null;
let categories = [];
let menuItems = [];
let cart = [];
let orderType = "dine_in";
let currentCategory = "all";
let slug = new URLSearchParams(window.location.search).get("slug");

// INIT
init();

async function init(){
  if(!slug){
    document.body.innerHTML="<h2 class='text-center mt-20'>Invalid Restaurant</h2>";
    return;
  }

  const {data:rest} = await supabase
    .from("restaurants")
    .select("*")
    .eq("slug",slug)
    .single();

  restaurant = rest;
  document.getElementById("restaurantName").innerText = rest.name;

  loadCategories();
  loadMenu();
}

async function loadCategories(){
  const {data} = await supabase
    .from("categories")
    .select("*")
    .eq("restaurant_id",restaurant.id)
    .order("sort_order");

  categories = data;
  renderCategories();
}

async function loadMenu(){
  const {data} = await supabase
    .from("menu_items")
    .select("*")
    .eq("restaurant_id",restaurant.id)
    .eq("is_available",true);

  menuItems = data;
  renderMenu();
}

function renderCategories(){
  const div = document.getElementById("categories");
  div.innerHTML = `
  <button onclick="selectCategory('all')" 
  class="px-4 py-2 rounded-full glass">All</button>
  `;

  categories.forEach(c=>{
    div.innerHTML += `
    <button onclick="selectCategory('${c.id}')" 
    class="px-4 py-2 rounded-full glass">
    ${c.emoji || "üçΩ"} ${c.name}
    </button>
    `;
  });
}

function selectCategory(id){
  currentCategory=id;
  renderMenu();
}

function renderMenu(){
  const div = document.getElementById("menu");
  let filtered = menuItems;

  if(currentCategory!=="all"){
    filtered = filtered.filter(m=>m.category_id==currentCategory);
  }

  div.innerHTML="";
  filtered.forEach(item=>{
    div.innerHTML+=`
    <div class="glass rounded-xl p-2">
      <img src="${item.image_url}" class="rounded-xl h-28 w-full object-cover">
      <h4 class="mt-2 font-semibold text-sm">${item.name}</h4>
      <p class="text-xs opacity-60">${item.description||""}</p>
      <div class="flex justify-between items-center mt-2">
        <span>‚Çπ${item.price}</span>
        <button onclick="addToCart('${item.id}','${item.name}',${item.price})"
        class="btn-grad px-3 py-1 rounded-lg text-xs">ADD</button>
      </div>
    </div>
    `;
  });
}

function addToCart(id,name,price){
  const existing = cart.find(c=>c.id==id);
  if(existing){
    existing.qty++;
  }else{
    cart.push({id,name,price,qty:1});
  }
  document.getElementById("cartBtn").classList.remove("hidden");
}

document.getElementById("cartBtn").onclick = checkout;

async function checkout(){

  if(cart.length==0) return;

  const total = cart.reduce((sum,i)=>sum+(i.price*i.qty),0);

  const {data:order} = await supabase
    .from("orders")
    .insert({
      restaurant_id: restaurant.id,
      order_type: orderType,
      table_number: "Table 7",
      total_amount: total,
      status: "pending"
    })
    .select()
    .single();

  for(const item of cart){
    await supabase.from("order_items").insert({
      order_id: order.id,
      menu_item_id: item.id,
      quantity: item.qty,
      price: item.price
    });
  }

  alert("Order Placed!");
  cart=[];
  document.getElementById("cartBtn").classList.add("hidden");
}

</script>
</body>
</html>