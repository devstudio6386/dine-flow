<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Luxe Dine</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

<style>
:root{
--bg-primary:linear-gradient(135deg,#0D001A 0%,#1A0030 50%,#000D1A 100%);
--pink-hot:#FF006E;
--blue-electric:#00D4FF;
--purple-mid:#8B00FF;
--card-glass:rgba(255,255,255,0.06);
--card-border:rgba(255,105,180,0.2);
--text-muted:rgba(255,255,255,0.55);
}
body{
margin:0;
font-family:'Poppins',sans-serif;
background:var(--bg-primary);
color:white;
}
.glass-card{
background:var(--card-glass);
border:1px solid var(--card-border);
backdrop-filter:blur(20px);
border-radius:16px;
}
.btn-gradient{
background:linear-gradient(135deg,var(--pink-hot),var(--purple-mid));
}
.food-card:hover{
transform:translateY(-6px);
transition:0.3s;
}
</style>
</head>

<body>

<!-- HEADER -->
<header class="sticky top-0 z-50 p-4 backdrop-blur-lg" style="background:linear-gradient(180deg,#1A0030 0%,rgba(26,0,48,0.95)100%);border-bottom:1px solid rgba(255,105,180,0.2);">

<div class="flex justify-between items-center max-w-lg mx-auto mb-3">

<div>
<h2 id="restaurantName" class="font-semibold text-lg">Loading...</h2>
<p id="tableDisplay" class="text-xs text-white/60"></p>
</div>

<div class="flex gap-2">
<button onclick="switchType('dine')" id="dineBtn" class="px-4 py-2 rounded-xl btn-gradient text-sm font-semibold">üçΩÔ∏è Dine In</button>
<button onclick="switchType('delivery')" id="deliveryBtn" class="px-4 py-2 rounded-xl bg-white/10 text-sm">üõµ Online</button>
</div>

</div>

</header>

<!-- MAIN -->
<main class="px-4 pb-32 max-w-lg mx-auto">

<!-- SEARCH -->
<div class="mt-4 mb-4">
<input id="searchInput" type="text" placeholder="Search food..." class="w-full p-3 rounded-xl bg-white/10 border border-pink-500/40 text-sm">
</div>

<!-- CATEGORY -->
<div id="categoryContainer" class="flex gap-3 overflow-x-auto pb-3"></div>

<!-- BANNER -->
<div id="bannerContainer" class="mb-6"></div>

<!-- MENU -->
<div id="menuContainer" class="grid grid-cols-2 gap-3"></div>

<!-- CART BUTTON -->
<button id="cartBtn" onclick="toggleCart()" class="fixed bottom-6 right-6 w-14 h-14 rounded-full btn-gradient hidden">üõí</button>

<!-- CART PANEL -->
<div id="cartPanel" class="fixed bottom-0 left-0 right-0 bg-[#1A0030] p-4 hidden">
<h3 class="font-semibold mb-3">Your Cart</h3>
<div id="cartItems"></div>
<div class="flex justify-between mt-3">
<span>Total:</span>
<span id="cartTotal">‚Çπ0</span>
</div>
<button onclick="placeOrder()" class="w-full mt-3 p-3 btn-gradient rounded-xl">Place Order</button>
</div>

<script>

// ---------------- SUPABASE CONFIG ----------------
// ‚ö†Ô∏è YAHAN APNA SUPABASE URL & ANON KEY DAALO
const SUPABASE_URL = "https://azmzjibyyprombrreqmf.supabase.co";
const SUPABASE_KEY = "sb_publishable_yQqSAx25nwqoax6S-LPxCw_Wt6zLT5G";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ---------------- GLOBAL VARIABLES ----------------
let restaurantId = null;
let slug = null;
let tableNumber = null;
let orderType = "dine"; // dine | delivery
let cart = [];
let activeCategory = "all";
let searchText = "";

// ---------------- URL DETECT ----------------
function detectParams(){
const params = new URLSearchParams(window.location.search);
slug = params.get("slug");
tableNumber = params.get("table");

if(!slug){
alert("Restaurant not found");
return;
}

if(tableNumber){
document.getElementById("tableDisplay").innerText = "Table " + tableNumber;
}else{
document.getElementById("tableDisplay").innerText = "Online Order";
orderType = "delivery";
}
}

// ---------------- FETCH RESTAURANT ----------------
async function loadRestaurant(){
const {data} = await sb
.from("restaurants")
.select("*")
.eq("slug",slug)
.single();

if(!data){
alert("Invalid restaurant");
return;
}

restaurantId = data.id;
document.getElementById("restaurantName").innerText = data.name;

loadCategories();
loadMenu();
}

// ---------------- LOAD CATEGORIES ----------------
async function loadCategories(){
const {data} = await sb
.from("categories")
.select("*")
.eq("restaurant_id",restaurantId);

let html = <button onclick="selectCategory('all')" class="glass-card px-3 py-2 text-sm">All</button>;

data.forEach(cat=>{
html += <button onclick="selectCategory('${cat.id}')" class="glass-card px-3 py-2 text-sm">${cat.name}</button>;
});

document.getElementById("categoryContainer").innerHTML = html;
}

// ---------------- LOAD MENU ----------------
async function loadMenu(){

let query = sb
.from("menu_items")
.select("*")
.eq("restaurant_id",restaurantId)
.eq("available",true);

if(activeCategory !== "all"){
query = query.eq("category_id",activeCategory);
}

const {data} = await query;

let filtered = data;

if(searchText){
filtered = filtered.filter(i => i.name.toLowerCase().includes(searchText.toLowerCase()));
}

let html = "";

filtered.forEach(item=>{
html += `
<div class="glass-card p-3 food-card">
<img src="${item.image || ''}" class="w-full h-28 object-cover rounded-xl mb-2">
<h4 class="font-semibold text-sm">${item.name}</h4>
<p class="text-xs text-white/60">‚Çπ${item.price}</p>
<button onclick="addToCart('${item.id}','${item.name}',${item.price})" class="btn-gradient w-full mt-2 p-2 rounded-lg text-sm">Add</button>
</div>
`;
});

document.getElementById("menuContainer").innerHTML = html;

}

// ---------------- SEARCH ----------------
document.getElementById("searchInput").addEventListener("input",(e)=>{
searchText = e.target.value;
loadMenu();
});

// ---------------- CATEGORY SELECT ----------------
function selectCategory(id){
activeCategory = id;
loadMenu();
}

// ---------------- CART ----------------
function addToCart(id,name,price){
let existing = cart.find(i=>i.id===id);
if(existing){
existing.qty++;
}else{
cart.push({id,name,price,qty:1});
}
updateCartUI();
}

function updateCartUI(){
if(cart.length>0){
document.getElementById("cartBtn").classList.remove("hidden");
}else{
document.getElementById("cartBtn").classList.add("hidden");
}

let html="";
let total=0;

cart.forEach(item=>{
total+=item.price*item.qty;
html+=`
<div class="flex justify-between mb-2">
<span>${item.name} x${item.qty}</span>
<span>‚Çπ${item.price*item.qty}</span>
</div>
`;
});

document.getElementById("cartItems").innerHTML=html;
document.getElementById("cartTotal").innerText="‚Çπ"+total;
}

// ---------------- TOGGLE CART ----------------
function toggleCart(){
document.getElementById("cartPanel").classList.toggle("hidden");
}

// ---------------- ORDER TYPE ----------------
function switchType(type){
orderType = type;
if(type==="delivery"){
document.getElementById("tableDisplay").innerText="Delivery Order";
}
}

// ---------------- PLACE ORDER ----------------
async function placeOrder(){

if(cart.length===0) return;

let orderData = {
restaurant_id: restaurantId,
table_number: orderType==="dine" ? tableNumber : null,
order_type: orderType==="dine" ? "dine_in" : "delivery",
status: "pending"
};

const {data:order} = await sb
.from("orders")
.insert(orderData)
.select()
.single();

for(const item of cart){
await sb.from("order_items").insert({
order_id:order.id,
menu_item_id:item.id,
name:item.name,
price:item.price,
quantity:item.qty
});
}

alert("Order placed!");
cart=[];
updateCartUI();
toggleCart();
}

// ---------------- INIT ----------------
detectParams();
loadRestaurant();

</script>

<script>

// ---------------- BANNER ----------------
function loadBanner(){
document.getElementById("bannerContainer").innerHTML = `
<div class="glass-card p-5 mb-4" style="background:linear-gradient(135deg,#FF006E,#8B00FF);">
<h2 class="text-xl font-bold">üî• Special Offer</h2>
<p class="text-sm text-white/80">Order now & get instant discount</p>
</div>
`;
}
loadBanner();


// ---------------- DELIVERY ADDRESS MODAL ----------------
function openAddressModal(){

if(orderType!=="delivery") return;

let modal = document.createElement("div");
modal.style.position="fixed";
modal.style.inset="0";
modal.style.background="rgba(0,0,0,0.7)";
modal.style.display="flex";
modal.style.alignItems="center";
modal.style.justifyContent="center";

modal.innerHTML=`
<div class="bg-[#1A0030] p-5 rounded-2xl w-[90%] max-w-md">
<h3 class="mb-3 font-semibold">Delivery Details</h3>
<input id="custName" placeholder="Name" class="w-full p-2 mb-2 rounded bg-white/10">
<input id="custPhone" placeholder="Phone" class="w-full p-2 mb-2 rounded bg-white/10">
<textarea id="custAddress" placeholder="Address" class="w-full p-2 mb-3 rounded bg-white/10"></textarea>
<button onclick="saveAddress()" class="w-full btn-gradient p-2 rounded-xl">Save</button>
</div>
`;

document.body.appendChild(modal);
modal.onclick=(e)=>{if(e.target===modal) modal.remove();}
}

let deliveryDetails=null;

function saveAddress(){
deliveryDetails={
name:document.getElementById("custName").value,
phone:document.getElementById("custPhone").value,
address:document.getElementById("custAddress").value
};
document.querySelector("body > div:last-child").remove();
alert("Address Saved");
}


// ---------------- TABLE MERGE LOGIC ----------------
async function getActiveTableOrder(){

if(orderType!=="dine") return null;

const {data} = await sb
.from("orders")
.select("*")
.eq("restaurant_id",restaurantId)
.eq("table_number",tableNumber)
.neq("status","billed")
.limit(1);

return data.length>0 ? data[0] : null;
}


// ---------------- UPDATED PLACE ORDER ----------------
async function placeOrder(){

if(cart.length===0) return;

let existingOrder = await getActiveTableOrder();

let orderId;

if(existingOrder){
orderId = existingOrder.id;
}else{

let orderData = {
restaurant_id: restaurantId,
table_number: orderType==="dine" ? tableNumber : null,
order_type: orderType==="dine" ? "dine_in" : "delivery",
customer_name: orderType==="delivery" ? deliveryDetails?.name : null,
phone: orderType==="delivery" ? deliveryDetails?.phone : null,
address: orderType==="delivery" ? deliveryDetails?.address : null,
status:"pending"
};

const {data:order} = await sb
.from("orders")
.insert(orderData)
.select()
.single();

orderId = order.id;
}

// Insert items
for(const item of cart){
await sb.from("order_items").insert({
order_id:orderId,
menu_item_id:item.id,
name:item.name,
price:item.price,
quantity:item.qty
});
}

alert("Order Placed Successfully!");

cart=[];
updateCartUI();
toggleCart();
}


// ---------------- ADDRESS CLICK ENABLE ----------------
document.getElementById("tableDisplay").addEventListener("click",()=>{
if(orderType==="delivery"){
openAddressModal();
}
});

</script>

</main>
</body>
</html>