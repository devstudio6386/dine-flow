<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Luxe ERP Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root{
  --pink:#FF006E;
  --purple:#8B00FF;
  --blue:#00D4FF;
}

body{
  background:linear-gradient(135deg,#0D001A,#1A0030,#000D1A);
  color:#fff;
  font-family:Poppins,sans-serif;
  margin:0;
}

.glass{
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(20px);
  border:1px solid rgba(255,0,110,0.2);
}

.sidebar-btn{
  transition:0.3s;
  padding:12px;
  border-radius:8px;
  cursor:pointer;
}

.sidebar-btn:hover{
  background:linear-gradient(90deg,var(--pink),var(--purple));
}

.section{
  display:none;
}

.active{
  display:block;
}
</style>
</head>

<body class="flex min-h-screen">

<!-- SIDEBAR -->
<div class="w-64 p-6 glass space-y-3">

<h2 class="text-xl font-bold mb-6 text-pink-400">
Luxe ERP
</h2>

<div class="sidebar-btn" onclick="showSection('overview')">üìä Overview</div>
<div class="sidebar-btn" onclick="showSection('orders')">üì¶ Orders</div>
<div class="sidebar-btn" onclick="showSection('billing')">üßæ Billing</div>
<div class="sidebar-btn" onclick="showSection('categories')">üìÇ Categories</div>
<div class="sidebar-btn" onclick="showSection('menu')">üçΩ Menu</div>
<div class="sidebar-btn" onclick="showSection('banner')">üéâ Banner</div>
<div class="sidebar-btn" onclick="showSection('revenue')">üí∞ Revenue</div>
<div class="sidebar-btn" onclick="showSection('reports')">üìë Reports</div>

</div>

<!-- MAIN CONTENT -->
<div class="flex-1 p-8 overflow-y-auto">

<!-- OVERVIEW -->
<div id="overview" class="section active">
<h2 class="text-2xl mb-6">Overview</h2>
<div id="overviewContent"></div>
</div>

<!-- ORDERS -->
<div id="orders" class="section">
<h2 class="text-2xl mb-6">Orders</h2>
<div id="ordersContent"></div>
</div>

<!-- BILLING -->
<div id="billing" class="section">
<h2 class="text-2xl mb-6">Billing</h2>
<div id="billingContent"></div>
</div>

<!-- CATEGORIES -->
<div id="categories" class="section">
<h2 class="text-2xl mb-6">Categories</h2>
<div id="categoriesContent"></div>
</div>

<!-- MENU -->
<div id="menu" class="section">
<h2 class="text-2xl mb-6">Menu</h2>
<div id="menuContent"></div>
</div>

<!-- BANNER -->
<div id="banner" class="section">
<h2 class="text-2xl mb-6">Banner</h2>
<div id="bannerContent"></div>
</div>

<!-- REVENUE -->
<div id="revenue" class="section">
<h2 class="text-2xl mb-6">Revenue</h2>
<div id="revenueContent"></div>
</div>

<!-- REPORTS -->
<div id="reports" class="section">
<h2 class="text-2xl mb-6">Reports</h2>
<div id="reportsContent"></div>
</div>

</div>

<script>

/* ================= SUPABASE CONFIG ================= */

const SUPABASE_URL = "https://nauqzjzbmlzdnnryzdan.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_ypvRXwLPQbokKid4nGi8AA_dITP8eca";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let profile = null;
let restaurantId = null;

/* ================= INIT ================= */

init();

async function init(){

const { data:{ session } } = await supabase.auth.getSession();

if(!session){
  alert("Login required");
  window.location.href="login.html";
  return;
}

const { data } = await supabase
.from("profiles")
.select("*")
.eq("id", session.user.id)
.single();

profile = data;
restaurantId = profile.restaurant_id;

if(profile.role !== "owner"){
  alert("Access denied");
  window.location.href="login.html";
  return;
}

}

/* ================= SECTION SWITCH ================= */

function showSection(id){
document.querySelectorAll(".section")
.forEach(s=>s.classList.remove("active"));
document.getElementById(id)
.classList.add("active");
}

/* ================= SESSION ENGINE ================= */

/*
Logic:

1. First order of table ‚Üí new session
2. Same table ‚Üí attach to active session
3. When billed ‚Üí session closed
4. Next visit same table ‚Üí new session
*/

async function getOrCreateSession(tableNumber){

// check active session
const { data: existing } = await supabase
.from("table_sessions")
.select("*")
.eq("restaurant_id", restaurantId)
.eq("table_number", tableNumber)
.eq("status","active")
.maybeSingle();

if(existing){
  return existing.id;
}

// create new session
const { data: newSession } = await supabase
.from("table_sessions")
.insert({
restaurant_id: restaurantId,
table_number: tableNumber,
status:"active"
})
.select()
.single();

return newSession.id;
}

async function closeSession(sessionId){

await supabase
.from("table_sessions")
.update({
status:"billed",
closed_at:new Date()
})
.eq("id",sessionId);

}

/* ================= OVERVIEW STATS ================= */

async function loadOverview(){

const today=new Date();
today.setHours(0,0,0,0);

const { data:orders } = await supabase
.from("orders")
.select("*")
.eq("restaurant_id",restaurantId)
.gte("created_at",today.toISOString());

let totalOrders=0;
let revenue=0;
let pending=0;
let completed=0;

if(orders){
orders.forEach(o=>{
totalOrders++;
revenue+=o.total_amount || 0;
if(o.status==="pending") pending++;
if(o.status==="completed") completed++;
});
}

document.getElementById("overviewContent").innerHTML=`

<div class="grid grid-cols-4 gap-6">

<div class="glass p-6 rounded">
<p>Today Orders</p>
<h3 class="text-2xl">${totalOrders}</h3>
</div>

<div class="glass p-6 rounded">
<p>Revenue Today</p>
<h3 class="text-2xl">‚Çπ${revenue}</h3>
</div>

<div class="glass p-6 rounded">
<p>Pending</p>
<h3 class="text-2xl">${pending}</h3>
</div>

<div class="glass p-6 rounded">
<p>Completed</p>
<h3 class="text-2xl">${completed}</h3>
</div>

</div>
`;

}

loadOverview();

/* ================= ORDERS SECTION ================= */

async function loadOrders(){

const { data } = await supabase
.from("orders")
.select("*")
.eq("restaurant_id",restaurantId)
.order("created_at",{ascending:false});

let html="";

if(!data || data.length===0){
html="<p>No orders yet</p>";
}else{

data.forEach(o=>{

html+=`
<div class="glass p-4 mb-4 rounded">

<b>Table ${o.table_number}</b>
<br>
Amount: ‚Çπ${o.total_amount}
<br>
Status: ${o.status}
<br><br>

<button onclick="updateOrderStatus('${o.id}','completed')"
class="px-3 py-1 bg-blue-600 rounded">
Mark Completed
</button>

<button onclick="updateOrderStatus('${o.id}','pending')"
class="px-3 py-1 bg-yellow-600 rounded ml-2">
Mark Pending
</button>

</div>
`;

});

}

document.getElementById("ordersContent").innerHTML=html;

}

async function updateOrderStatus(orderId,status){

await supabase
.from("orders")
.update({status})
.eq("id",orderId);

loadOrders();
loadOverview();
}

loadOrders();

/* ================= BILLING SECTION ================= */

function renderBillingUI(){

document.getElementById("billingContent").innerHTML=`

<input id="billTableInput"
placeholder="Enter Table Number"
class="p-3 bg-black/30 border rounded">

<button onclick="generateBill()"
class="ml-4 px-6 py-3 bg-pink-600 rounded">
Generate Bill
</button>

<div id="billOutput" class="mt-6"></div>
`;

}

renderBillingUI();

async function generateBill(){

const table=document.getElementById("billTableInput").value;

if(!table){
alert("Enter table number");
return;
}

// get active session
const { data: session } = await supabase
.from("table_sessions")
.select("*")
.eq("restaurant_id",restaurantId)
.eq("table_number",table)
.eq("status","active")
.maybeSingle();

if(!session){
alert("No active session");
return;
}

// get completed orders
const { data: orders } = await supabase
.from("orders")
.select("*")
.eq("session_id",session.id)
.eq("status","completed");

if(!orders || orders.length===0){
alert("No completed orders for this table");
return;
}

let total=0;
let breakdown="";

orders.forEach(o=>{
total+=o.total_amount || 0;
breakdown+=<div>‚Çπ${o.total_amount}</div>;
});

// show bill
document.getElementById("billOutput").innerHTML=`

<div class="glass p-6 rounded">

<h3 class="text-xl mb-4">Table ${table} Bill</h3>

${breakdown}

<hr class="my-4">

<b>Total ‚Çπ${total}</b>

<br><br>

<button onclick="finalizeBill('${session.id}')"
class="px-6 py-3 bg-green-600 rounded">
Confirm & Close
</button>

</div>
`;

}

async function finalizeBill(sessionId){

await closeSession(sessionId);

loadOrders();
loadOverview();

document.getElementById("billOutput").innerHTML=
"<p>Bill closed successfully.</p>";

}


/* ================= CATEGORIES ================= */

function renderCategoryUI(){

document.getElementById("categoriesContent").innerHTML=`

<div class="mb-6">

<input id="catName"
placeholder="Category Name"
class="p-3 bg-black/30 rounded">

<input id="catEmoji"
placeholder="Emoji"
class="p-3 bg-black/30 rounded ml-2">

<button onclick="addCategory()"
class="ml-2 px-4 py-3 bg-pink-600 rounded">
Add Category
</button>

</div>

<div id="categoryList"></div>
`;

}

renderCategoryUI();

async function loadCategories(){

const { data } = await supabase
.from("categories")
.select("*")
.eq("restaurant_id",restaurantId)
.order("created_at",{ascending:true});

let html="";

if(!data || data.length===0){
html="<p>No categories yet</p>";
}else{

data.forEach(c=>{
html+=`
<div class="glass p-3 mb-3 rounded flex justify-between">

<div>
${c.emoji || ""} ${c.name}
</div>

<div>
<button onclick="deleteCategory('${c.id}')"
class="px-3 py-1 bg-red-600 rounded">
Delete
</button>
</div>

</div>
`;
});

}

document.getElementById("categoryList").innerHTML=html;

// update menu dropdown
updateMenuCategoryDropdown(data);

}

async function addCategory(){

const name=document.getElementById("catName").value;
const emoji=document.getElementById("catEmoji").value;

if(!name){
alert("Enter category name");
return;
}

await supabase.from("categories").insert({
restaurant_id:restaurantId,
name,
emoji
});

document.getElementById("catName").value="";
document.getElementById("catEmoji").value="";

loadCategories();
}

async function deleteCategory(id){

await supabase.from("categories")
.delete().eq("id",id);

loadCategories();
}

loadCategories();

/* ================= MENU ================= */

function renderMenuUI(){

document.getElementById("menuContent").innerHTML=`

<div class="mb-6">

<input id="dishName"
placeholder="Dish Name"
class="p-3 bg-black/30 rounded">

<input id="dishPrice"
type="number"
placeholder="Price"
class="p-3 bg-black/30 rounded ml-2">

<select id="dishCategory"
class="p-3 bg-black/30 rounded ml-2">
</select>

<select id="dishVeg"
class="p-3 bg-black/30 rounded ml-2">
<option value="true">Veg</option>
<option value="false">Non-Veg</option>
</select>

<button onclick="saveDish()"
class="ml-2 px-4 py-3 bg-pink-600 rounded">
Save Dish
</button>

</div>

<div id="menuList"></div>
`;

}

renderMenuUI();

let editingDish=null;

function updateMenuCategoryDropdown(categories){

let select=document.getElementById("dishCategory");
if(!select) return;

select.innerHTML="";

if(categories){
categories.forEach(c=>{
select.innerHTML+=`<option value="${c.id}">
${c.emoji || ""} ${c.name}
</option>`;
});
}

}

async function loadMenu(){

const { data } = await supabase
.from("dishes")
.select("*,categories(name,emoji)")
.eq("restaurant_id",restaurantId);

let grouped={};

if(data){

data.forEach(d=>{
let cat=d.categories?.name || "Uncategorized";
if(!grouped[cat]) grouped[cat]=[];
grouped[cat].push(d);
});

}

let html="";

for(let cat in grouped){

html+=`
<h3 class="text-lg mt-6 mb-2 font-bold">
${grouped[cat][0].categories?.emoji || ""} ${cat}
</h3>
`;

grouped[cat].forEach(d=>{

html+=`
<div class="glass p-4 mb-2 rounded flex justify-between">

<div>
<b>${d.name}</b> ‚Çπ${d.price}
<br>
<span class="text-sm">
${d.is_veg ? "üü¢ Veg" : "üî¥ Non-Veg"}
|
${d.is_available ? "Available" : "Unavailable"}
</span>
</div>

<div>

<button onclick="editDish('${d.id}')"
class="px-3 py-1 bg-yellow-600 rounded">
Edit
</button>

<button onclick="toggleAvailability('${d.id}',${d.is_available})"
class="px-3 py-1 bg-blue-600 rounded ml-2">
Toggle
</button>

<button onclick="deleteDish('${d.id}')"
class="px-3 py-1 bg-red-600 rounded ml-2">
Delete
</button>

</div>

</div>
`;

});

}

document.getElementById("menuList").innerHTML=html;

}

async function saveDish(){

const name=document.getElementById("dishName").value;
const price=parseFloat(document.getElementById("dishPrice").value);
const category_id=document.getElementById("dishCategory").value;
const is_veg=document.getElementById("dishVeg").value==="true";

if(!name || !price){
alert("Fill name & price");
return;
}

if(editingDish){

await supabase.from("dishes")
.update({
name,
price,
category_id,
is_veg
})
.eq("id",editingDish);

editingDish=null;

}else{

await supabase.from("dishes").insert({
restaurant_id:restaurantId,
name,
price,
category_id,
is_veg,
is_available:true
});

}

document.getElementById("dishName").value="";
document.getElementById("dishPrice").value="";

loadMenu();
}

async function editDish(id){

const { data } = await supabase
.from("dishes")
.select("*")
.eq("id",id)
.single();

document.getElementById("dishName").value=data.name;
document.getElementById("dishPrice").value=data.price;
document.getElementById("dishCategory").value=data.category_id;
document.getElementById("dishVeg").value=data.is_veg;

editingDish=id;
}

async function toggleAvailability(id,current){

await supabase.from("dishes")
.update({is_available:!current})
.eq("id",id);

loadMenu();
}

async function deleteDish(id){

await supabase.from("dishes")
.delete().eq("id",id);

loadMenu();
}

loadMenu();

/* ================= BANNER ================= */

function renderBannerUI(){

document.getElementById("bannerContent").innerHTML=`

<div class="mb-6">

<input id="bannerTitle"
placeholder="Title"
class="p-3 bg-black/30 rounded">

<input id="bannerSubtitle"
placeholder="Subtitle"
class="p-3 bg-black/30 rounded ml-2">

<button onclick="saveBanner()"
class="ml-2 px-4 py-3 bg-pink-600 rounded">
Save Banner
</button>

</div>

<div id="bannerList"></div>
`;

}

renderBannerUI();

async function loadBanner(){

const { data } = await supabase
.from("banners")
.select("*")
.eq("restaurant_id",restaurantId);

let html="";

if(data){

data.forEach(b=>{
html+=`
<div class="glass p-4 mb-3 rounded flex justify-between">

<div>
<b>${b.title}</b>
<br>
<span>${b.subtitle}</span>
</div>

<button onclick="deleteBanner('${b.id}')"
class="px-3 py-1 bg-red-600 rounded">
Delete
</button>

</div>
`;
});

}

document.getElementById("bannerList").innerHTML=html;

}

async function saveBanner(){

const title=document.getElementById("bannerTitle").value;
const subtitle=document.getElementById("bannerSubtitle").value;

if(!title){
alert("Enter title");
return;
}

await supabase.from("banners").insert({
restaurant_id:restaurantId,
title,
subtitle
});

document.getElementById("bannerTitle").value="";
document.getElementById("bannerSubtitle").value="";

loadBanner();
}

async function deleteBanner(id){

await supabase.from("banners")
.delete().eq("id",id);

loadBanner();
}

loadBanner();


/* ================= REVENUE FILTER SYSTEM ================= */

function renderRevenueUI(){

document.getElementById("revenueContent").innerHTML=`

<div class="mb-6 flex gap-4">

<button onclick="loadRevenue('today')" 
class="px-4 py-2 bg-pink-600 rounded">
Today
</button>

<button onclick="loadRevenue('week')" 
class="px-4 py-2 bg-purple-600 rounded">
This Week
</button>

<button onclick="loadRevenue('month')" 
class="px-4 py-2 bg-blue-600 rounded">
This Month
</button>

<button onclick="loadRevenue('all')" 
class="px-4 py-2 bg-green-600 rounded">
All Time
</button>

<button onclick="exportExcel()" 
class="ml-auto px-4 py-2 bg-yellow-600 rounded">
Export Excel
</button>

</div>

<div id="revenueStats"></div>

<canvas id="revenueChart" height="120"></canvas>
`;

}

renderRevenueUI();


async function loadRevenue(type){

let startDate=null;
let now=new Date();

if(type==="today"){
startDate=new Date();
startDate.setHours(0,0,0,0);
}

if(type==="week"){
startDate=new Date();
startDate.setDate(now.getDate()-7);
}

if(type==="month"){
startDate=new Date();
startDate.setMonth(now.getMonth()-1);
}

let query=supabase
.from("orders")
.select("*")
.eq("restaurant_id",restaurantId)
.eq("status","completed");

if(type!=="all" && startDate){
query=query.gte("created_at",startDate.toISOString());
}

const { data } = await query;

let total=0;
let count=0;
let dailyMap={};

if(data){

data.forEach(o=>{
total+=o.total_amount || 0;
count++;

let day=new Date(o.created_at).toLocaleDateString();
if(!dailyMap[day]) dailyMap[day]=0;
dailyMap[day]+=o.total_amount || 0;

});

}

document.getElementById("revenueStats").innerHTML=`
<div class="grid grid-cols-2 gap-6 mb-6">

<div class="glass p-6 rounded">
<p>Total Revenue</p>
<h3 class="text-2xl">‚Çπ${total}</h3>
</div>

<div class="glass p-6 rounded">
<p>Total Orders</p>
<h3 class="text-2xl">${count}</h3>
</div>

</div>
`;

drawChart(dailyMap);

}

loadRevenue("today");


/* ================= CHART SYSTEM ================= */

let revenueChartInstance=null;

function drawChart(map){

const ctx=document.getElementById("revenueChart");

if(revenueChartInstance){
revenueChartInstance.destroy();
}

const labels=Object.keys(map);
const values=Object.values(map);

revenueChartInstance=new Chart(ctx,{
type:"line",
data:{
labels:labels,
datasets:[{
label:"Revenue",
data:values,
borderColor:"#ff006e",
backgroundColor:"rgba(255,0,110,0.2)",
tension:0.4
}]
},
options:{
plugins:{
legend:{display:false}
},
scales:{
x:{ticks:{color:"white"}},
y:{ticks:{color:"white"}}
}
}
});

}


/* ================= EXCEL EXPORT ================= */

async function exportExcel(){

const { data } = await supabase
.from("orders")
.select("*")
.eq("restaurant_id",restaurantId)
.eq("status","completed");

if(!data || data.length===0){
alert("No data to export");
return;
}

let csv="Table,Amount,Date\n";

data.forEach(o=>{
csv+=`${o.table_number},${o.total_amount},${o.created_at}\n`;
});

const blob=new Blob([csv],{type:"text/csv"});
const url=window.URL.createObjectURL(blob);

const a=document.createElement("a");
a.href=url;
a.download="daybook_report.csv";
a.click();

}


/* ================= REPORTS SECTION ================= */

function renderReportsUI(){

document.getElementById("reportsContent").innerHTML=`

<div class="glass p-6 rounded mb-6">

<h3 class="text-xl mb-4">Quick Reports</h3>

<button onclick="loadRevenue('today')" 
class="px-4 py-2 bg-pink-600 rounded mr-2">
Today Report
</button>

<button onclick="loadRevenue('week')" 
class="px-4 py-2 bg-purple-600 rounded mr-2">
Weekly Report
</button>

<button onclick="loadRevenue('month')" 
class="px-4 py-2 bg-blue-600 rounded">
Monthly Report
</button>

</div>

`;
}

renderReportsUI();


/* ================= AUTO REFRESH ================= */

setInterval(()=>{
loadOverview();
loadOrders();
},10000);


/* ================= LOAD CHART SCRIPT ================= */

// Chart.js CDN load
const chartScript=document.createElement("script");
chartScript.src="https://cdn.jsdelivr.net/npm/chart.js";
document.head.appendChild(chartScript);

</script>

    
</body>
</html>