<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Admin Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{
  font-family:'Poppins',sans-serif;
  background:#0f172a;
  color:#fff;
  margin:0;
  padding:20px;
}

h2{margin-bottom:20px;}

.card{
  background:linear-gradient(145deg,#1e293b,#172033);
  padding:24px;
  border-radius:20px;
  margin:18px 0;
  border:1px solid rgba(255,255,255,0.05);
  box-shadow:0 10px 30px rgba(0,0,0,0.5);
}

button{
  padding:10px 18px;
  border:none;
  border-radius:25px;
  cursor:pointer;
  font-weight:600;
  background:linear-gradient(45deg,#ff4ecd,#4e73ff);
  color:#fff;
  margin:6px 6px 0 0;
  transition:.3s;
}

button:hover{
  transform:translateY(-3px);
  box-shadow:0 10px 25px rgba(0,0,0,0.4);
}

input{
  padding:10px;
  border-radius:10px;
  border:1px solid #334155;
  background:#1e293b;
  color:#fff;
  width:100%;
  max-width:250px;
  margin:5px 5px 0 0;
}

#stats{
  display:flex;
  gap:15px;
  margin-bottom:25px;
  flex-wrap:wrap;
}

.stat-card{
  flex:1;
  min-width:150px;
  padding:25px;
  border-radius:18px;
  background:linear-gradient(145deg,#1e293b,#172033);
  border:1px solid rgba(255,255,255,0.05);
  box-shadow:0 15px 40px rgba(0,0,0,0.5);
  text-align:center;
}

.stat-card h2{
  font-size:30px;
  margin:0;
}

.stat-card p{
  margin-top:8px;
  font-size:14px;
  color:#94a3b8;
}

#modules{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:15px;
  margin-bottom:25px;
}

.module-btn{
  background:linear-gradient(145deg,#1e293b,#172033);
  padding:30px;
  border-radius:20px;
  text-align:center;
  cursor:pointer;
  border:1px solid rgba(255,255,255,0.05);
  transition:.3s;
  font-weight:600;
  font-size:16px;
}

.module-btn:hover{
  transform:translateY(-6px);
  box-shadow:0 20px 40px rgba(0,0,0,0.6);
}

.module-btn:hover{
  background:#243046;
}

.section{
  display:none;
  margin-top: 40px;
}

.new-badge{
  background:#ef4444;
  color:#fff;
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
  font-weight:700;
  margin-left:10px;
  animation:blink 1s infinite;
}

@keyframes blink{
  0%{opacity:1;}
  50%{opacity:0.3;}
  100%{opacity:1;}
}

/* ===== NOTIFICATION TOAST ===== */
#toast-container{
  position:fixed;
  top:20px;
  right:20px;
  z-index:9999;
}

.toast{
  padding:14px 18px;
  border-radius:10px;
  color:#fff;
  font-weight:600;
  margin-bottom:10px;
  box-shadow:0 5px 20px rgba(0,0,0,0.3);
  animation:slideIn .3s ease;
}




@keyframes slideIn{
  from{transform:translateX(100%);opacity:0;}
  to{transform:translateX(0);opacity:1;}
}



.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
}

.logo{
  font-size:22px;
  font-weight:700;
  letter-spacing:0.5px;
}

.live-indicator{
  background:#0f1f17;
  color:#22c55e;
  padding:6px 14px;
  border-radius:20px;
  font-size:13px;
  border:1px solid #22c55e33;
}

.status-pending{color:#f97316;font-weight:600;}
.status-preparing{color:#eab308;font-weight:600;
}
.status-served{color:#3b82f6;font-weight:600;}
.status-completed{color:#22c55e;font-weight:600;
}
.status-billed{color:#a855f7;font-weight:600;}
</style>

</head>
<body>
  <!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<div class="topbar">
  <div class="logo">
    üç¥ <span>Restaurant Admin</span>
  </div>
  <div class="live-indicator">
    ‚óè Live
  </div>
</div>

<div id="stats"></div>

<div id="modules">
  <div class="module-btn" onclick="showSection('trackOrders')">üì¶ Track Orders</div>
  <div class="module-btn" onclick="showSection('orderManagement')">üìä Order Management</div>
  <div class="module-btn" onclick="showSection('manageDashboard')">üçΩ Manage Dishes</div>
  <div class="module-btn" onclick="showSection('generateBill')">
  üßæ Generate Bill
</div>
</div>

<!-- TRACK -->
<div id="trackOrders" class="section">
  <h3>üõí Live Orders</h3>
  <div id="orders"></div>

  <h3>üîî Waiter Calls</h3>
  <div id="waiters"></div>
</div>

<!-- ORDER MANAGEMENT -->
<div id="orderManagement" class="section">
  <h3>üìä Today Orders</h3>
  <button onclick="downloadTodayReport()">Download Today Report</button>
  <div id="orders"></div>
</div>

<!-- MANAGE DASHBOARD -->
<div id="manageDashboard" class="section">
  <h3>‚ûï Add Dish</h3>
  <input id="name" placeholder="Name">
  <input id="price" type="number" placeholder="Price">
  <input id="category" placeholder="Category">
  <input id="image" placeholder="Image URL">
  <button onclick="saveDish()">Save</button>

  <h3 style="margin-top:30px;">üìã All Dishes</h3>
  <div id="dishes"></div>
</div>

<!-- GENERATE BILL SECTION -->
<div id="generateBill" class="section">
  <h3>üßæ Generate Bill</h3>

  <input id="billTableNumber" placeholder="Enter Table Number">
  <button onclick="generateCompletedBill()">Generate Bill</button>

  <div id="billResult" style="margin-top:20px;"></div>
</div>

<script>
const SUPABASE_URL = "https://azmzjibyyprombrreqmf.supabase.co";
const SUPABASE_KEY = "sb_publishable_yQqSAx25nwqoax6S-LPxCw_Wt6zLT5G";


async function loadRestaurantId() {

  if (!restaurantSlug) {
    alert("No restaurant selected in URL");
    return;
  }

  const { data, error } = await sb
    .from("restaurants")
    .select("id")
    .eq("slug", restaurantSlug)
    .single();

  if (error || !data) {
    alert("Restaurant not found");
    console.log(error);
    return;
  }

  RESTAURANT_ID = data.id;

  console.log("Restaurant Loaded:", RESTAURANT_ID);

  loadOrders();
  loadWaiters();
  loadDishes();
}

let RESTAURANT_ID = null;

const params = new URLSearchParams(window.location.search);
let restaurantSlug = params.get("slug");

// Agar URL me slug nahi mila to localStorage se lo
if (!restaurantSlug) {
  restaurantSlug = localStorage.getItem("restaurantSlug");
}

// Agar slug mil gaya to save kar do
if (restaurantSlug) {
  localStorage.setItem("restaurantSlug", restaurantSlug);
} else {
  alert("No restaurant selected");
}

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);
let CURRENT_BILL_ORDERS = [];

/* ===== TOAST FUNCTION ===== */
function showToast(message,color){
  const container=document.getElementById("toast-container");
  const toast=document.createElement("div");
  toast.className="toast";
  toast.style.background=color;
  toast.innerText=message;
  container.appendChild(toast);
  setTimeout(()=>{toast.remove();},4000);
}

// ===== SOUND SYSTEM =====
const orderSound = new Audio("notification.mpeg");
const waiterSound = new Audio("waiter.mpeg");

function playOrderSound(){
  orderSound.currentTime = 0;
  orderSound.play().catch(()=>{});
}

function playWaiterSound(){
  waiterSound.currentTime = 0;
  waiterSound.play().catch(()=>{});
}
/* ===== SECTION SWITCH ===== */
function showSection(id){
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

/* ===== ORDERS ===== */
async function loadOrders(){
  const today = new Date();
today.setHours(0,0,0,0); // raat 12 se start

const { data: orders } = await sb.from("orders")
.select("*")
.eq("restaurant_id", RESTAURANT_ID)
.gte("created_at", today.toISOString())
.order("created_at", { ascending: false });

  const box=document.getElementById("orders");
  box.innerHTML="";
  if(!orders||orders.length===0){box.innerHTML="No orders";return;}

  const {data:allDishes}=await sb.from("dishes").select("id,name");

  for(let o of orders){
    let itemsHTML="";
    if(o.items){
      for(let item of o.items){
        const dish=allDishes.find(d=>d.id===item.id);
        if(dish) itemsHTML+=dish.name+" √ó "+item.quantity+"<br>";
      }
    }

    box.innerHTML+=`
  <div class="card">
    <b>
Table ${o.table_number}
${o.status === "pending" ? '<span class="new-badge">NEW</span>' : ''}
</b><br>

    ${itemsHTML}

    <br>Status: <span class="status-${o.status}">${o.status}</span>
    <br>Total: ‚Çπ${o.total_amount}<br>

   ${o.status === "billed"
? `
<span style="color:#a855f7;font-weight:700;">
‚úÖ Billed
</span>
`
: `
<button onclick="updateStatus('${o.id}','preparing')">
Preparing
</button>

<button onclick="updateStatus('${o.id}','served')">
Served
</button>

${o.status !== "completed"
? `
<button onclick="updateStatus('${o.id}','completed')">
Completed
</button>
`
: `
<span style="color:#22c55e;font-weight:700;">
‚úÖ Ready for Billing
</span>
`
}
`
}

  </div>
`;
  }

  loadStats();
}

async function updateStatus(id,status){

  const { data } = await sb
    .from("orders")
    .select("status")
    .eq("id", id)
    .single();

  if(data.status === "billed"){
    alert("Already billed. Cannot change.");
    return;
  }

  await sb
    .from("orders")
    .update({status})
    .eq("id",id);

  loadOrders();
}

/* ===== STATS ===== */
async function loadStats(){
  const today=new Date();
  today.setHours(0,0,0,0);

  const {data:orders}=await sb.from("orders")
    .select("*")
    .eq("restaurant_id",RESTAURANT_ID)
    .gte("created_at",today.toISOString());

  if(!orders)return;

  let revenue=0,pending=0,completed=0;
  orders.forEach(o=>{
    revenue+=o.total_amount;
    if(o.status==="completed") completed++;
else if(o.status==="pending" || o.status==="preparing" || o.status==="served") pending++;
  });

  document.getElementById("stats").innerHTML=`
  <div class="stat-card">
    <h2>‚Çπ${revenue}</h2>
    <p>Revenue Today</p>
  </div>

  <div class="stat-card">
    <h2>${orders.length}</h2>
    <p>Total Orders</p>
  </div>

  <div class="stat-card">
    <h2>${completed}</h2>
    <p>Completed</p>
  </div>

  <div class="stat-card">
    <h2>${pending}</h2>
    <p>Active Orders</p>
  </div>
`;
}

/* ===== WAITER ===== */
async function loadWaiters(){
  const {data}=await sb.from("waiter_calls")
  .select("*")
  .eq("restaurant_id",RESTAURANT_ID)
  .eq("status","pending");

  const box=document.getElementById("waiters");
  box.innerHTML="";
  if(!data||data.length===0){box.innerHTML="No waiter calls";return;}

  for(let w of data){
    box.innerHTML+=`
      <div class="card">
        Table ${w.table_number}
        <button onclick="doneWaiter('${w.id}')">Done</button>
      </div>
    `;
  }
}

async function doneWaiter(id){
  await sb.from("waiter_calls").update({status:"served"}).eq("id",id);
  loadWaiters();
}

/* ===== DISHES ===== */
async function loadDishes(){
  const {data}=await sb.from("dishes")
  .select("*")
  .eq("restaurant_id",RESTAURANT_ID);

  const box=document.getElementById("dishes");
  box.innerHTML="";
  if(!data)return;

  for(let d of data){
    box.innerHTML+=`
      <div class="card">
        <b>${d.name}</b> ‚Çπ${d.price}
        ${d.is_available === false 
          ? '<span style="color:#ef4444;font-weight:600;margin-left:10px;">(Unavailable)</span>' 
          : ''}

        <br><br>

        <button onclick="editDish('${d.id}')">Edit</button>
        <button onclick="deleteDish('${d.id}')">Delete</button>

        <button onclick="toggleAvailability('${d.id}', ${d.is_available})"
        style="background:${d.is_available ? '#ef4444' : '#22c55e'}">
        ${d.is_available ? 'Mark Unavailable' : 'Mark Available'}
        </button>
      </div>
    `;
  }
}

function editDish(id){
  sb.from("dishes").select("*").eq("id",id).single()
  .then(res=>{
    const d=res.data;
    document.getElementById("name").value=d.name;
    document.getElementById("price").value=d.price;
    document.getElementById("category").value=d.category;
    document.getElementById("image").value=d.image;
    editingId=id;
  });
}

async function toggleAvailability(id,currentStatus){
  const { error } = await sb
    .from("dishes")
    .update({ is_available: !currentStatus })
    .eq("id", id);

  if(error){
    alert("Update failed");
    console.log(error);
    return;
  }

  loadDishes();
}

async function saveDish(){
  const name=document.getElementById("name").value;
  const price=parseFloat(document.getElementById("price").value);
  const category=document.getElementById("category").value;
  const image=document.getElementById("image").value;

  if(!name||isNaN(price)){alert("Name & Price required");return;}

  if(editingId){
    await sb.from("dishes")
    .update({name,price,category,image}).eq("id",editingId);
    editingId=null;
    alert("Dish Updated Successfully ‚úÖ");
  }else{
    await sb.from("dishes")
.insert([{
  restaurant_id:RESTAURANT_ID,
  name,
  price,
  category,
  image,
  is_available:true
}]);
    alert("Dish Added Successfully ‚úÖ");
  }

  document.getElementById("name").value="";
  document.getElementById("price").value="";
  document.getElementById("category").value="";
  document.getElementById("image").value="";

  loadDishes();
}

async function deleteDish(id){
  const confirmDelete=confirm("Delete this dish?");
  if(!confirmDelete) return;

  await sb.from("dishes").delete().eq("id",id);
  alert("Dish Deleted Successfully ‚ùå");
  loadDishes();
}

/* ===== INIT ===== */
showSection('trackOrders');
loadRestaurantId();


async function downloadTodayReport(){

  try {

    const today = new Date();
    today.setHours(0,0,0,0);

   const { data: orders, error } = await sb
  .from("orders")
  .select("*")
  .eq("restaurant_id", RESTAURANT_ID)
  .gte("created_at", today.toISOString())
  .order("created_at", { ascending: true });

    if(error){
      console.error(error);
      alert("Error loading orders");
      return;
    }

    if(!orders || orders.length === 0){
      alert("No orders today");
      return;
    }

    const { data: allDishes } = await sb
      .from("dishes")
      .select("id,name");

    let csv = "Table,Items,Status,Total,Date\n";
    let grandTotal = 0;

    orders.forEach(o => {

      let itemsText = "";

      if(o.items && Array.isArray(o.items)){
        itemsText = o.items.map(item=>{
          const dish = allDishes.find(d=>d.id===item.id);
          return dish ? dish.name + " x" + item.quantity : "";
        }).join(" | ");
      }
grandTotal += o.total_amount;
      const formattedDate = new Date(o.created_at)
        .toLocaleString("en-IN");

      csv += o.table_number + "," +
             '"' + itemsText + '",' +
             o.status + "," +
             o.total_amount + "," +
             '"' + formattedDate + '"' +
             "\n";

    });

    csv += "\n";
csv += "-----------------------------\n";
csv += "Grand Total,,," + grandTotal + "\n";

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "today_orders.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

  } catch(err) {
    console.error(err);
    alert("Something went wrong");
  }
}


// ===== REALTIME ORDERS =====

const channel = sb.channel('orders-realtime');

channel
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'orders'
    },
    (payload) => {

  if(payload.new.restaurant_id !== RESTAURANT_ID) return;

  console.log("üî• NEW ORDER:", payload);
  showToast("üî• New Order Received!","#22c55e");
  playOrderSound();
  loadOrders();
}
  )
  .subscribe((status) => {
    console.log("üì° Status:", status);
  });


 // ===== WAITER CALLS REALTIME =====

const waiterChannel = sb.channel('waiter-calls-realtime');

waiterChannel
  .on(
    'postgres_changes',
    {
      event: '*',
      schema: 'public',
      table: 'waiter_calls'
    },
   (payload) => {

  if(payload.new.restaurant_id !== RESTAURANT_ID) return;

  console.log("üîî WAITER EVENT:", payload);
  showToast("üîî Waiter Called!","#f97316");
  playWaiterSound();
  loadWaiters();
}
  )
  .subscribe((status) => {
    console.log("üõ∞ WAITER STATUS:", status);
  });

async function generateCompletedBill(){

  const tableNumber = document.getElementById("billTableNumber").value;

  if(!tableNumber){
    alert("Enter table number");
    return;
  }
const today = new Date();
today.setHours(0,0,0,0);

const { data: orders } = await sb
  .from("orders")
  .select("*")
  .eq("restaurant_id", RESTAURANT_ID)
  .eq("table_number", tableNumber)
  .eq("status","completed")
  .gte("created_at", today.toISOString());
  

  if(!orders || orders.length === 0){
    document.getElementById("billResult").innerHTML =
      "No completed orders for this table";
    return;
    
  }

  CURRENT_BILL_ORDERS = orders;

  const { data: allDishes } = await sb
    .from("dishes")
    .select("id,name,price");

  let mergedItems = {};
  let total = 0;

  orders.forEach(o=>{
    total += o.total_amount;

    o.items.forEach(item=>{
      if(!mergedItems[item.id]){
        mergedItems[item.id] = item.quantity;
      } else {
        mergedItems[item.id] += item.quantity;
      }
    });
  });

  let itemsHTML = "";

  Object.keys(mergedItems).forEach(id=>{
    const dish = allDishes.find(d=>d.id == id);
    if(dish){
      const qty = mergedItems[id];
      const price = dish.price * qty;
      itemsHTML += `${dish.name} x ${qty} = ‚Çπ${price}<br>`;
    }
  });

 document.getElementById("billResult").innerHTML = `
<div class="card">
  <h4>Table ${tableNumber} Bill</h4>
  <hr>
  ${itemsHTML}
  <hr>
  <b>Total: ‚Çπ${total}</b>
  <br><br>
  <button onclick="downloadBillPDF('${tableNumber}')">
    Download PDF
  </button>
</div>
`;
await sb
  .from("orders")
  .update({ status: "billed" })
  .eq("restaurant_id", RESTAURANT_ID)
  .eq("table_number", tableNumber)
  .eq("status", "completed")
  .gte("created_at", today.toISOString());

await loadOrders();        // üî• instant UI refresh

}

  // ===== PDF DESIGN =====
async function downloadBillPDF(tableNumber, total){

  const { jsPDF } = window.jspdf;

  // Fetch restaurant name
  const { data: restaurant } = await sb
    .from("restaurants")
    .select("name")
    .eq("id", RESTAURANT_ID)
    .single();

  const restaurantName = restaurant?.name || "Restaurant";

  // Fetch completed orders
const orders = CURRENT_BILL_ORDERS;

if(!orders || orders.length === 0){
  alert("No bill generated");
  return;
}

  const { data: allDishes } = await sb
    .from("dishes")
    .select("id,name,price");

  let mergedItems = {};
  let grandTotal = 0;

  orders.forEach(o=>{
    if(o.items){
      o.items.forEach(item=>{
        if(!mergedItems[item.id]){
          mergedItems[item.id] = item.quantity;
        } else {
          mergedItems[item.id] += item.quantity;
        }
      });
    }
  });

  // Calculate page height dynamically
  const itemCount = Object.keys(mergedItems).length;
  const pageHeight = 100 + (itemCount * 8);

  const doc = new jsPDF({
    unit: "mm",
    format: [80, pageHeight]
  });

  let y = 10;

  doc.setFontSize(12);
  doc.text(restaurantName, 40, y, { align: "center" });
  y += 8;

  doc.setFontSize(9);
  doc.text("Table: " + tableNumber, 5, y);
  y += 5;

  doc.text("Date: " + new Date().toLocaleString(), 5, y);
  y += 6;

  doc.line(5, y, 75, y);
  y += 6;

  doc.text("Item", 5, y);
  doc.text("Qty", 40, y);
  doc.text("Total", 60, y);
  y += 4;

  doc.line(5, y, 75, y);
  y += 6;

  Object.keys(mergedItems).forEach(id=>{
    const dish = allDishes.find(d => d.id == id);
    if(dish){
      const qty = mergedItems[id];
      const totalItem = dish.price * qty;
      grandTotal += totalItem;

      doc.text(dish.name, 5, y);
      doc.text(String(qty), 40, y);
      doc.text("Rs " + totalItem, 60, y);
      y += 6;
    }
  });

  doc.line(5, y, 75, y);
  y += 6;

  doc.setFontSize(10);
  doc.text("Grand Total: Rs " + grandTotal, 5, y);
  y += 8;

  doc.setFontSize(9);
  doc.text("Thank You! Visit Again", 40, y, { align: "center" });

  doc.save(restaurantName + "_Table" + tableNumber + "_Bill.pdf");
}


  
</script>

</body>
</html>